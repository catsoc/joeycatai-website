---
import BaseLayout from './BaseLayout.astro';
import FormattedDate from '@/components/FormattedDate.astro';
import { SITE } from '@/site.config';

export interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  tags?: string[];
  lang?: 'zh-TW' | 'en';
  readingTime?: number;
}

const { title, description, pubDate, updatedDate, heroImage, tags = [], lang = 'zh-TW', readingTime } = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, SITE.url);

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  datePublished: pubDate.toISOString(),
  ...(updatedDate && { dateModified: updatedDate.toISOString() }),
  author: {
    '@type': 'Person',
    name: SITE.author,
    url: SITE.url,
  },
  url: canonicalURL,
  ...(heroImage && { image: heroImage.startsWith('http') ? heroImage : new URL(heroImage, SITE.url).toString() }),
  keywords: tags.join(', '),
};
---

<BaseLayout
  title={title}
  description={description}
  image={heroImage}
  article
  pubDate={pubDate}
  updatedDate={updatedDate}
  tags={tags}
  lang={lang}
>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(articleSchema)} />

  <article class="container-base py-12">
    <!-- Back link -->
    <a
      href="/blog"
      class="inline-flex items-center gap-1.5 text-sm text-slate-500 dark:text-slate-400 hover:text-accent-600 dark:hover:text-accent-400 mb-8 transition-colors"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      所有文章
    </a>

    <!-- Header -->
    <header class="mb-8">
      {heroImage && (
        <img
          src={heroImage}
          alt={title}
          class="w-full aspect-[2/1] object-cover rounded-xl mb-8 shadow-md"
        />
      )}
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.map((tag) => (
          <a href={`/tags/${tag.toLowerCase()}`} class="tag hover:opacity-80 transition-opacity">
            {tag}
          </a>
        ))}
      </div>
      <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
        {title}
      </h1>
      <p class="text-lg text-slate-600 dark:text-slate-400 mb-4">{description}</p>
      <div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-500">
        <FormattedDate date={pubDate} />
        {readingTime && (
          <>
            <span>·</span>
            <span>{readingTime} 分鐘閱讀</span>
          </>
        )}
        {updatedDate && (
          <>
            <span>·</span>
            <span>更新於 <FormattedDate date={updatedDate} /></span>
          </>
        )}
      </div>
    </header>

    <hr class="border-slate-200 dark:border-slate-700 mb-8" />

    <!-- Content -->
    <div class="prose-custom">
      <slot />
    </div>
  </article>
</BaseLayout>

<script>
  function attachCopyButtons() {
    document.querySelectorAll('pre.astro-code:not([data-copy-attached])').forEach((pre) => {
      pre.setAttribute('data-copy-attached', '');
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.textContent = '複製';
      btn.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.innerText ?? pre.innerText;
        await navigator.clipboard.writeText(code);
        btn.textContent = '已複製！';
        setTimeout(() => { btn.textContent = '複製'; }, 2000);
      });
      wrapper.appendChild(btn);
    });
  }

  document.addEventListener('astro:page-load', attachCopyButtons);
</script>
